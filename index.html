<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>四季送り自陣に質問をしちゃおうサイト</title>
<style>
    :root {
        --accent-color: #333; /* 墨色 */
        --bg-color: #fcfcfc;
    }
    body { 
        font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", "MS PMincho", serif;
        background-color: var(--bg-color);
        color: #222;
        margin: 0;
        padding: 40px 10px;
        line-height: 1.8;
    }
    .container { max-width: 600px; margin: 0 auto; }
    
    h1 { 
        font-size: 1.4rem; 
        font-weight: normal;
        text-align: center; 
        margin-bottom: 20px; 
        letter-spacing: 0.2em;
    }
    h5 { text-align: center; color: #888; font-weight: normal; margin-bottom: 40px; }

    .admin-section {
        background: #fff;
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid #e0e0e0;
        position: relative;
    }

    /* 和風の装飾線 */
    .admin-section::before {
        content: "";
        position: absolute;
        top: 0; left: 0;
        width: 4px; height: 100%;
        background-color: var(--accent-color);
    }

    h3 { font-size: 1rem; margin-top: 0; margin-bottom: 20px; color: #444; font-weight: bold; border-left: 2px solid #ccc; padding-left: 10px; }

    label { display:block; margin-top:15px; font-size: 0.85rem; font-weight: bold; color: #444; }
    
    input[type="text"], select {
        width: 100%;
        padding: 8px 0;
        margin-top: 5px;
        border: none;
        border-bottom: 1px solid #ccc;
        font-size: 1rem;
        font-family: inherit;
        outline: none;
        background: transparent;
    }

    button { 
        padding: 8px 15px; 
        cursor: pointer; 
        font-size: 0.8rem;
        background: #fff;
        border: 1px solid #222;
        transition: 0.3s;
        border-radius: 4px;
        font-family: inherit;
    }
    button:hover { background: #222; color: #fff; }
    .btn-update { background-color: #f0f7ff; border-color: #007bff; color: #007bff; }
    .btn-update:hover { background-color: #007bff; color: #fff; }
    .btn-delete { background-color: #fff5f5; border-color: #ff4d4d; color: #ff4d4d; }
    .btn-delete:hover { background-color: #ff4d4d; color: #fff; }

    /* チャート */
    .chart-wrapper {
        text-align: center;
        background: #fff;
        padding: 20px 0;
        margin: 40px 0;
        border: 1px solid #eee;
    }
    canvas { max-width: 100%; height: auto; }

    /* スライダー */
    input[type="range"] {
        -webkit-appearance: none; width: 100%; height: 1px; background: #ccc; outline: none; margin: 20px 0;
    }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none; width: 16px; height: 16px; background: #fff; border: 1px solid #222; border-radius: 50%; cursor: pointer;
    }

    /* 回答一覧 */
    .answer-item { 
        display: flex; align-items: center; padding: 12px 0; border-bottom: 1px dotted #ccc; font-size: 0.9rem;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 15px; }
</style>
</head>
<body>

<div class="container">
    <h1>四季送り自陣に質問をしちゃおうサイト</h1>
    <h5>バグ等あれば一報ください再編集します!</h5>

    <div class="admin-section">
        <h3>質問の管理</h3>
        <label>タイトル:</label>
        <input id="questionTitle" value="お酒は？">
        
        <label>フレームの色（四季のアクセント）:</label>
        <input type="color" id="frameColor" value="#333333" style="width:100%; height:30px; border:none; background:none; cursor:pointer;">

        <p>横軸：
            左 <input id="xLeft" value="嫌い" style="width:80px;"> 
            右 <input id="xRight" value="好き" style="width:80px;">
        </p>
        <p>縦軸：
            下 <input id="yBottom" value="弱い" style="width:80px;"> 
            上 <input id="yTop" value="強い" style="width:80px;">
        </p>

        <div style="margin-top:20px;">
            <button id="addQuestionBtn">新規追加</button>
            <button id="updateQuestionBtn" class="btn-update">選択中の質問を更新</button>
            <button id="deleteQuestionBtn" class="btn-delete">この質問を削除</button>
        </div>
    </div>

    <label>表示する質問を選択：</label>
    <select id="questionSelect"></select>

    <div class="chart-wrapper">
        <canvas id="chart" width="400" height="400"></canvas>
    </div>

    <div class="admin-section">
        <h3>回答者設定</h3>
        <div style="display: flex; gap: 15px; align-items: flex-end;">
            <div style="flex:2"><label>名前</label><input id="userNameInput"></div>
            <div style="flex:1"><label>色</label><input type="color" id="userColorInput" value="#ff0000" style="height:35px; width:100%;"></div>
        </div>
        <button id="saveProfileBtn" style="width:100%; margin-top:20px;">プロフィール保存</button>

        <div style="margin-top:40px;">
            <p id="xLabel" style="text-align:center; font-weight:bold; margin-bottom:0;"></p>
            <input type="range" min="1" max="20" value="10" id="xValue">

            <p id="yLabel" style="text-align:center; font-weight:bold; margin-bottom:0;"></p>
            <input type="range" min="1" max="20" value="10" id="yValue">

            <button id="submitAnswerBtn" style="width: 100%; background: #222; color: white; border:none; padding: 15px; font-size: 1.1em; margin-top:10px;">この位置で回答する</button>
        </div>
    </div>

    <div class="admin-section">
        <h3>回答一覧</h3>
        <div id="answerList"></div>
    </div>
</div>

<script>
const STORAGE_KEY = "crossChartData_shiki_v3";
const chart = document.getElementById("chart");
const ctx = chart.getContext("2d");
const margin = 50, size = 300;

let questions = [];
let currentIndex = -1;
let savedProfile = null;
let editIndex = null;

const el = {
    title: document.getElementById("questionTitle"),
    fColor: document.getElementById("frameColor"),
    xL: document.getElementById("xLeft"), xR: document.getElementById("xRight"),
    yT: document.getElementById("yTop"), yB: document.getElementById("yBottom"),
    select: document.getElementById("questionSelect"),
    uName: document.getElementById("userNameInput"),
    uColor: document.getElementById("userColorInput"),
    list: document.getElementById("answerList"),
    xlLab: document.getElementById("xLabel"),
    ylLab: document.getElementById("yLabel")
};

function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ questions })); }
function loadData() {
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (!data || !data.questions || data.questions.length === 0) { initEmpty(); return; }
    questions = data.questions;
    refreshSelect(); currentIndex = 0; syncState();
}

function initEmpty() {
    questions = []; refreshSelect(); currentIndex = -1;
    ctx.clearRect(0,0,400,400);
    el.list.innerHTML = "質問がありません。";
}

function refreshSelect() {
    el.select.innerHTML = "";
    questions.forEach((q, i) => {
        const opt = document.createElement("option");
        opt.value = i; opt.text = q.title;
        el.select.appendChild(opt);
    });
}

function syncState() {
    if (currentIndex >= 0) {
        const q = questions[currentIndex];
        document.documentElement.style.setProperty('--accent-color', q.frameColor || '#333');
        el.title.value = q.title;
        el.fColor.value = q.frameColor || '#333';
        el.xL.value = q.xLeft; el.xR.value = q.xRight;
        el.yT.value = q.yTop; el.yB.value = q.yBottom;
        updateLabels(); drawAll(); renderAnswerList();
    }
}

function updateLabels() {
    const q = questions[currentIndex];
    if(!q) return;
    el.xlLab.innerText = `${q.xLeft} ← (横) → ${q.xRight}`;
    el.ylLab.innerText = `${q.yBottom} ← (縦) → ${q.yTop}`;
}

function drawAll() {
    if (currentIndex < 0) return;
    const q = questions[currentIndex];
    ctx.clearRect(0,0,400,400);
    
    // 軸
    ctx.beginPath();
    ctx.strokeStyle = "#eee";
    ctx.lineWidth = 1;
    ctx.moveTo(margin, 200); ctx.lineTo(margin+size, 200);
    ctx.moveTo(200, margin); ctx.lineTo(200, margin+size);
    ctx.stroke();

    // ラベル描画
    ctx.fillStyle = "#999";
    ctx.font = "12px 'Yu Mincho'";
    ctx.textAlign = "center";
    ctx.fillText(q.xLeft, margin - 20, 205);
    ctx.fillText(q.xRight, margin+size + 20, 205);
    ctx.fillText(q.yTop, 200, margin - 15);
    ctx.fillText(q.yBottom, 200, margin+size + 25);

    // 回答プロット
    q.answers.forEach(a => {
        const px = margin + (a.x - 1) * (size / 19);
        const py = margin + (21 - a.y) * (size / 19);
        ctx.fillStyle = a.color;
        ctx.beginPath(); ctx.arc(px,py,7,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.stroke();
        ctx.fillStyle = "#222";
        ctx.font = "11px sans-serif";
        ctx.fillText(a.name, px, py-15);
    });

    // 中央の質問（短冊フレーム）
    const txt = q.title;
    ctx.font = "bold 15px 'Yu Mincho'";
    const tw = ctx.measureText(txt).width;
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.fillRect(200 - (tw/2) - 15, 185, tw + 30, 30);
    ctx.strokeStyle = q.frameColor || "#333";
    ctx.lineWidth = 1.5;
    ctx.strokeRect(200 - (tw/2) - 15, 185, tw + 30, 30);
    ctx.fillStyle = "#222";
    ctx.textBaseline = "middle";
    ctx.fillText(txt, 200, 200);
}

function renderAnswerList() {
    el.list.innerHTML = "";
    if (currentIndex < 0) return;
    questions[currentIndex].answers.forEach((a,i) => {
        const div = document.createElement("div");
        div.className = "answer-item";
        div.innerHTML = `<span class="dot" style="background:${a.color}"></span><span style="flex-grow:1"><strong>${a.name}</strong> (${a.x}, ${a.y})</span>
            <button onclick="editAnswer(${i})" style="border:none; color:#888;">変更</button>
            <button onclick="deleteAnswer(${i})" style="border:none; color:#ff4d4d;">削除</button>`;
        el.list.appendChild(div);
    });
}

saveProfileBtn.onclick = () => {
    if (!el.uName.value.trim()) { alert("名前を入力してください"); return; }
    savedProfile = { name: el.uName.value.trim(), color: el.uColor.value };
    alert("設定を保存しました");
};

addQuestionBtn.onclick = () => {
    questions.push({
        title: el.title.value, frameColor: el.fColor.value,
        xLeft: el.xL.value, xRight: el.xR.value,
        yTop: el.yT.value, yBottom: el.yB.value, answers:[]
    });
    refreshSelect(); currentIndex = questions.length - 1;
    el.select.value = currentIndex; saveData(); syncState();
};

updateQuestionBtn.onclick = () => {
    if (currentIndex < 0) return;
    const q = questions[currentIndex];
    q.title = el.title.value; q.frameColor = el.fColor.value;
    q.xLeft = el.xL.value; q.xRight = el.xR.value;
    q.yTop = el.yT.value; q.yBottom = el.yB.value;
    saveData(); syncState();
};

deleteQuestionBtn.onclick = () => {
    if (currentIndex < 0 || !confirm("この質問を削除しますか？")) return;
    questions.splice(currentIndex, 1);
    currentIndex = questions.length > 0 ? 0 : -1;
    refreshSelect(); saveData(); syncState();
};

el.select.onchange = () => { currentIndex = Number(el.select.value); syncState(); };

submitAnswerBtn.onclick = () => {
    if (!savedProfile) { alert("先に名前と色を設定して「プロフィール保存」してください"); return; }
    const data = { name: savedProfile.name, color: savedProfile.color, 
                   x: Number(document.getElementById("xValue").value), 
                   y: Number(document.getElementById("yValue").value) };
    if (editIndex !== null) { questions[currentIndex].answers[editIndex] = data; editIndex = null; }
    else { questions[currentIndex].answers.push(data); }
    saveData(); drawAll(); renderAnswerList();
};

window.editAnswer = i => {
    const a = questions[currentIndex].answers[i];
    el.uName.value = a.name; el.uColor.value = a.color;
    document.getElementById("xValue").value = a.x;
    document.getElementById("yValue").value = a.y;
    savedProfile = { name:a.name, color:a.color };
    editIndex = i;
};

window.deleteAnswer = i => {
    questions[currentIndex].answers.splice(i,1);
    saveData(); drawAll(); renderAnswerList();
};

loadData();
</script>
</body>
</html>