<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>四季送り自陣 リアルタイム質問板</title>
    <style>
        :root { --main: #222; --bg: #fcfcfc; --edit-q: #fff9e6; --edit-a: #eef7ff; }
        body { font-family: "Yu Mincho", serif; background: var(--bg); color: var(--main); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 700px; margin: 0 auto; }
        
        .admin-panel { background: #fff; border: 2px solid var(--main); padding: 20px; margin-bottom: 50px; transition: 0.3s; }
        .admin-panel.editing { background: var(--edit-q); border-color: #d4a017; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; box-sizing: border-box; font-family: inherit; }
        
        button { cursor: pointer; border: 1px solid var(--main); background: #fff; transition: 0.2s; font-family: inherit; }
        button:hover { background: var(--main); color: #fff; }
        
        .q-card { background: #fff; border: 1px solid #ddd; padding: 25px; margin-bottom: 60px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .q-title { text-align: center; font-size: 1.4rem; margin-bottom: 20px; border-bottom: 2px solid var(--main); width: 100%; }
        
        .chart-box { position: relative; width: 450px; height: 450px; margin: 0 auto 30px; background: #fff; border: 8px solid var(--f-color); cursor: pointer; }
        @media (max-width: 500px) { .chart-box { width: 300px; height: 300px; } }
        canvas { width: 100%; height: 100%; display: block; }
        
        .ans-form { background: #f9f9f9; padding: 20px; border-top: 1px solid #eee; transition: 0.3s; }
        .ans-form.editing-ans { background: var(--edit-a); border: 2px solid #007bff; }
        .ans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        
        .range-box { text-align: center; font-size: 0.8rem; font-weight: bold; margin: 15px 0; position: relative; }
        .slider-container { position: relative; width: 100%; padding: 10px 0; }
        .mid-line { position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background: #bbb; z-index: 1; pointer-events: none; }
        input[type="range"] { position: relative; z-index: 2; cursor: ew-resize; }

        .btn-row { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; gap: 10px; }
        .mode-label { font-size: 0.8rem; font-weight: bold; margin-bottom: 8px; display: none; }
        .q-edit-msg { color: #d4a017; }
        .a-edit-msg { color: #007bff; }
        .danger-text { color: #cc0000; cursor: pointer; font-size: 0.7rem; text-decoration: underline; }
        
        .member-list { margin-top: 15px; border-top: 1px dotted #ccc; padding-top: 10px; }
        .member-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; padding: 4px 0; }

        #tooltip { position: absolute; display: none; background: rgba(0,0,0,0.85); color: #fff; padding: 10px; border-radius: 5px; font-size: 0.85rem; z-index: 1000; pointer-events: none; max-width: 220px; }
    </style>
</head>
<body>

<div id="tooltip"></div>

<div class="container">
    <h1 style="text-align:center; letter-spacing: 0.2em;">四季送り自陣 質問板</h1>
    <div id="qContainer"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDceh-nvP9lIcKjjo5GdnpYGRZOOws5U7Q",
    authDomain: "shikiokuri-jijin.firebaseapp.com",
    databaseURL: "https://shikiokuri-jijin-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "shikiokuri-jijin",
    storageBucket: "shikiokuri-jijin.firebasestorage.app",
    messagingSenderId: "661663755417",
    appId: "1:661663755417:web:547998312085895e825c08"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db, 'shiki_v6'); 

let questions = [];
let localImageData = {};

onValue(dbRef, (snapshot) => {
    questions = snapshot.val() || [];
    renderCards();
});

function renderCards() {
    const container = document.getElementById("qContainer");
    container.innerHTML = "";
    questions.forEach((q, qIdx) => {
        const card = document.createElement("div");
        card.className = "q-card";
        card.innerHTML = `
            <div class="q-title">${q.title}</div>
            <div class="chart-box" style="--f-color: ${q.frameColor}" onclick="checkClick(event, ${qIdx})">
                <canvas id="can-${qIdx}" width="450" height="450"></canvas>
            </div>
        `;
        container.appendChild(card);
        drawChart(qIdx);
    });
}

async function drawChart(idx) {
    const q = questions[idx];
    const canvas = document.getElementById(\`can-\${idx}\`);
    if(!canvas) return;
    const ctx = canvas.getContext("2d");

    ctx.clearRect(0,0,450,450);
    ctx.strokeStyle = "#eee";
    ctx.beginPath();
    ctx.moveTo(50,225); ctx.lineTo(400,225);
    ctx.moveTo(225,50); ctx.lineTo(225,400);
    ctx.stroke();

    ctx.fillStyle = "#999";
    ctx.font = "bold 13px serif";
    ctx.textAlign="center";
    ctx.fillText(q.xL, 25, 225);
    ctx.fillText(q.xR, 425, 225);
    ctx.fillText(q.yT, 225, 25);
    ctx.fillText(q.yB, 225, 435);

    if(!q.answers) return;

    for(const a of q.answers) {
        const px = 50 + (a.x / 100) * 350;
        const py = 50 + ((100 - a.y) / 100) * 350;
        const size = 50;

        if(a.img) {
            const img = new Image();
            img.src = a.img;
            await new Promise(r => img.onload = r);

            ctx.save();
            ctx.beginPath();
            ctx.arc(px, py, size/2, 0, Math.PI*2);
            ctx.clip();
            ctx.drawImage(img, px - size/2, py - size/2, size, size);
            ctx.restore();
        } else {
            ctx.fillStyle = "#333";
            ctx.beginPath();
            ctx.arc(px, py, 10, 0, Math.PI*2);
            ctx.fill();
        }

        ctx.fillStyle = "#000";
        ctx.font = "bold 11px sans-serif";
        ctx.fillText(a.name, px, py + (size/2) + 12);
    }
}
</script>
</body>
</html>
